class inherited ТББ_Базовый.Базовые.картДокумент "Заявки на назначение пособий";

import classes Константы;

inclass private

--{{ Свойства
  var ПолеСтолбцаНаше: String:= 'НашеУчреждение.Имя';
  var КлассИнтерфейса: Class МашинаРеквизитов.Базовые.интЗапись = Данные.интЗаявкаНаНазначениеПособия;
--}}

inclass public

  func ВыполнитьВыбор (var локРезультатВыбора :Данные.ЗаявкаНаНазначениеПособия; локДопустимыеЗаявки: Данные.ЗаявкаНаНазначениеПособия[]): integer;
    var locCrd: Данные.картЗаявкаНаНазначениеПособия;
    var locResult: Данные.ЗаявкаНаНазначениеПособия;
    var locId[], i :integer;
    if (LengthOfArray(локДопустимыеЗаявки)=1) :
      локРезультатВыбора = локДопустимыеЗаявки[1];
      Return CmOk;
    fi;
    locId = nil;
    for i = 1 .. LengthOfArray(локДопустимыеЗаявки) do
      locId[i] = локДопустимыеЗаявки[i].DocId;
    od;
    locCrd = Данные.картЗаявкаНаНазначениеПособия.Create;
    locCrd.CardFile.UserFilter = 'DocId in ' + Str(locId);
    if (CmOk = locCrd.ShowEx(locResult, , Kernel.Window.ModalWindow)):
      локРезультатВыбора = locResult;
      Return CmOk;
    fi;
  end;

-- Обработчики событий картотеки --

inobject private

  func картотека_ПриСозданииЗаписи (var locRecord: Данные.ЗаявкаНаНазначениеПособия): Logical;
    var локВсеНашиУчреждения: Базовый.Данные.Субъект[];
    var локНашеУчреждение: Базовый.Данные.Субъект;
    var локПараметрыНовойЗаписи: variant[2];
    var i, nn: integer;
    if (НашеУчреждение = nil): -- определение учреждения документа и возможности выбора учреждения
      локВсеНашиУчреждения = ТББ_Базовый.Библио.ВсеНашиУчреждения;
      if (LengthOfArray(локВсеНашиУчреждения) = 1):
        локНашеУчреждение = локВсеНашиУчреждения[1];
      else
        if (CmOk <> ТББ_Базовый.Библио.ВыборНашегоУчреждения(локНашеУчреждение)):
          Return;
        fi;
      fi;
    else
      локНашеУчреждение = НашеУчреждение;
    fi;
    if (локНашеУчреждение = nil) :
      Return;
    fi;
    if (CmOk <> Служебные.блНоваяЗаявкаНаНазначениеПособия.OpenForm(локНашеУчреждение,локПараметрыНовойЗаписи)):
      Return;
    fi;
    nn = LengthOfArray(локПараметрыНовойЗаписи);
    for i = 1 .. nn do
      ДобавитьПараметрНовойЗаписи(локПараметрыНовойЗаписи[i,1], локПараметрыНовойЗаписи[i,2]);
    od;
    if inherited картотека_ПриСозданииЗаписи(locRecord):
      КлассИнтерфейса.БланкРедакторПоУмолчанию.ShowFormEx(locRecord);
    fi;
  end;

end