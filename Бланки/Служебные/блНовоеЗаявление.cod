Class inherited СИС2.БазовыйБланк "Мастер заявлений" ;

import classes Константы;


inobject private


  var РеквизитыЗаявления : Документы.РеквизитыЗаявления;

  var НашеУчреждение : Базовый.Данные.Субъект;
  var Субъект : Базовый.Данные.Субъект;
  var ТипРеестра : integer;
  var ДатаЗаявления : date;

inclass public

func CreateExt (локРеквизитыЗаявления : Документы.РеквизитыЗаявления): Служебные.блНовоеЗаявление;
  Result = Служебные.блНовоеЗаявление.Create;
  Result.РеквизитыЗаявления = локРеквизитыЗаявления;
end;

func OpenForm (локРеквизитыЗаявления : Документы.РеквизитыЗаявления): integer;
  var locForm: Служебные.блНовоеЗаявление;
  locForm = CreateExt (локРеквизитыЗаявления);
  if (CmOk = locForm.ShowEx( , Kernel.Window.ModalWindow)):
    Return CmOk;
  fi;
end;


inobject private


var секцРеквизиты : TemplateSection;


--{{ Обработчики событий шаблона

proc шаблон_ПриСоздании(Context :Variant);
  inherited шаблон_ПриСоздании(Context);
  ОбновитьСписокПоля(Template.CellByField['ТипРеестра'], ТипыРеестровНазначПос);
end;

proc шаблон_ПриОткрытии(Create :Logical);
  inherited шаблон_ПриОткрытии(Create);
  ПрочитатьПоля;
  ВидФормы;
end;



--}}

--{{ Обработчики событий клеток шаблона

func Поле_ПриВыводе (Cell: TemplateCell; Value: Variant; Action: Template.OutputTypes; var Format: String): string;
  Result = '';
  if (Cell.Contents = 'НашеУчреждение') :
    return if(НашеУчреждение <> nil : НашеУчреждение.Наим, '');
  elsif (Cell.Contents = 'Субъект') :
    return if(Субъект <> nil : Субъект.Наим, '');
  fi;
end;

func Поле_ПриВходе (Cell: TemplateCell; Index: Integer; Action: Template.EnterTypes): Logical;
  var локНашеУчреждение, локСубъект[] : Базовый.Данные.Субъект;
    Result = false;
    if (Cell.Contents = 'НашеУчреждение') :
      if (CmOk = ТББ_Базовый.Библио.ВыборНашегоУчреждения(локНашеУчреждение)):
        НашеУчреждение = локНашеУчреждение;
        ВидФормы;
      fi;
    elsif (Cell.Contents = 'Субъект') :
      if (CmOk = ТББ_Базовый.Справочники.Субъект.картСотрудник.ВыполнитьВыбор(локСубъект,НашеУчреждение)):
        Субъект = локСубъект[1];
        ВидФормы;
      fi;
    fi;
end;

proc ПолеТипРеестра_ПриВыходе(Cell: TemplateCell; Index: Integer);
  кнОк.Enabled = ВсеВведено;
end;

--}}

--{{ Обработчики событий прочих объектов шаблона

proc кнОк_ПриНажатии (Sender: Button);
  ЗаписатьПоля;
  inherited кнОк_ПриНажатии (Sender);
end;

--}}

--{{ Дополнительные команды
--}}

--{{ Вспомогательные методы

proc ПрочитатьПоля;
 НашеУчреждение = РеквизитыЗаявления.НашеУчреждение;
 Субъект = РеквизитыЗаявления.Субъект;
 ТипРеестра = РеквизитыЗаявления.ТипРеестра;
 ДатаЗаявления = РеквизитыЗаявления.ДатаЗаявления;
end;

proc ЗаписатьПоля;
 РеквизитыЗаявления.ЗапомнитьНашеУчреждение(НашеУчреждение);
 РеквизитыЗаявления.ЗапомнитьСубъект(Субъект);
 РеквизитыЗаявления.ЗапомнитьТипРеестра(ТипРеестра);
 РеквизитыЗаявления.ЗапомнитьДатаЗаявления(ДатаЗаявления);
end;


proc ВидФормы;
  var i : integer;
  var локВводНаше : logical;
    локВводНаше = if (РеквизитыЗаявления.НашеУчреждение <> nil : false, true);
    локВводНаше = if (локВводНаше and Субъект <> nil: false, локВводНаше);
    Template.BeginModify;
      for i = 1..секцРеквизиты.RowsCount do
        if (секцРеквизиты.Row[i].Name = 'стр_Рекв_Вывод') :
          секцРеквизиты.Row[i].Visible = not локВводНаше;
        elsif (секцРеквизиты.Row[i].Name = 'стр_Рекв_Ввод') :
          секцРеквизиты.Row[i].Visible = локВводНаше;
        fi;
      end;
      кнОк.Enabled = ВсеВведено;
    Template.EndModify;
end;

func ВсеВведено : logical;
  Result = true;
  if (НашеУчреждение = nil) :
    return false;
  fi;
  if (Субъект = nil) :
    return false;
  fi;
  if (ТипРеестра = ТипРеестраНП_Нет) :
    return false;
  fi;
  --дату вводить не обязательно
end;

--}}

end