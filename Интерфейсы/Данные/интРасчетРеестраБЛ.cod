class inherited МашинаРеквизитов.Базовые.интЗапись "Интерфейс записи РасчетВремНетрудИБеременность";

import classes Константы,ФункцииПримененияКостант;--,ФункцииДанных;

inclass public

  func СвязанныйКлассЗаписей: class СИС2.Базовая.БазоваяЗапись;
    Result = Данные.РасчетРеестраБЛ;
  end;

  func Create: Данные.интРасчетРеестраБЛ;
    Result = inherited Create;
    Result.Record = Данные.РасчетРеестраБЛ.Create;
  end;

  func ОткрытьПоЗаписи synonym OpenRecord (locRecord: Данные.РасчетРеестраБЛ): Данные.интРасчетРеестраБЛ;
    Result = inherited Create;
    Result.Record = locRecord;
  end;

  func БланкРедакторПоУмолчанию: class BlankForm;
    Result = nil;
  end;

  func КартотекаПоУмолчанию: class CardForm;
    Result = nil;
  end;

func ОткрытьПоЗаявке (локЗаявка : Данные.ЗаявкаНаНазначениеПособия): Данные.интРасчетРеестраБЛ;
  var локРасчет : Данные.РасчетРеестраБЛ;
    Result = nil;
    if (локЗаявка = nil) :
      return nil;
    fi;
    локРасчет = НайтиЗаписьПоЗаявке(локЗаявка);
    if (локРасчет = nil) :
      return nil;
    fi;
    Result = ОткрытьПоЗаписи(локРасчет);
end;


func НайтиЗаписьПоЗаявке(локЗаявка : Данные.ЗаявкаНаНазначениеПособия) :  Данные.РасчетРеестраБЛ;
var локФильтр : string;
  локФильтр = 'ЗаявкаНаНазначениеПособия = ' + Str(локЗаявка);
  Result = СИС2.ФункцииДокумента.QueryRecord(Данные.РасчетРеестраБЛ, локФильтр);
end;

proc СоздатьЗаписьПоЗаявке(локЗаявка : Данные.ЗаявкаНаНазначениеПособия);
  var локИнт : Данные.интРасчетРеестраБЛ;
    if (локЗаявка.ТипПособия = ТипПособияРанСрок) :
      return;
    fi;
    локИнт = Данные.интРасчетРеестраБЛ.Create;
    локИнт.НоваяЗаписьПоЗаявке(локЗаявка);

    локИнт.Record.Post;
end;



inobject public

  Record: Данные.РасчетРеестраБЛ;

proc ИнициализироватьПоУмолчанию synonym InitByDefault;
  inherited InitByDefault;
end;

proc НоваяЗаписьПоЗаявке(локЗаявка : Данные.ЗаявкаНаНазначениеПособия);
  ИнициализироватьПоУмолчанию;
  Self.Record.ЗаявкаНаНазначениеПособия = локЗаявка;
  if (локЗаявка.НазначениеПособия = nil) :
    return;
  fi;
  КопироватьИзБольничногоЛиста(локЗаявка.НазначениеПособия);
  ЗаписатьРасчетСС(локЗаявка.НазначениеПособия);
end;

proc КопироватьИзБольничногоЛиста(локНазначениеПособия : Бюджет_ЗПиДД.РасчетныеОперации.НазначениеПособия);
  var локБольничныйЛист : Бюджет_Персонал.Документы.Кадры.БольничныйЛист;
  --if (Self.Record.State <> Record.Created) then
  --  Self.Record.Edit;
  --end;
  if (локНазначениеПособия = nil) :
    return;
  fi;
  локБольничныйЛист = локНазначениеПособия.БольничныйЛист;
  if (локБольничныйЛист = nil) :
    return;
  fi;
  Self.Record.СтаховойСтажЛет = локБольничныйЛист.СтаховойСтажЛет;
  Self.Record.СтаховойСтажМес = локБольничныйЛист.СтаховойСтажМес;
  Self.Record.НестраховойПериодЛет = локБольничныйЛист.НестраховойПериодЛет;
  Self.Record.НестраховойПериодМес = локБольничныйЛист.НестраховойПериодМес;
  Self.Record.ДатаНачалаОплаты = локБольничныйЛист.ДатаНачалаОплаты;
  Self.Record.ДатаОкончанияОплаты = локБольничныйЛист.ДатаОкончанияОплаты;
end;

proc ЗаписатьРасчетСС(локНазначениеПособия : Бюджет_ЗПиДД.РасчетныеОперации.НазначениеПособия);
  var i,j : integer;
  var локИнт : Бюджет_ЗПиДД.Рабочие.интРасчетСзСС;
  var локРасчетСзСС : Бюджет_ЗПиДД.РасчетныеОперации.СреднийЗаработокСС;
    локИнт = Бюджет_ЗПиДД.Рабочие.интРасчетСзСС.НайтиПоЗаписиНазначенияПособия(локНазначениеПособия);
    if (локИнт = nil) :
      return;
    fi;
    локРасчетСзСС = локИнт.Record;
    if (локРасчетСзСС <> nil) :
      for i = 1..локРасчетСзСС.ГодРасчета.Count do
        j = Self.Record.ГодРасчета.Add;
        Self.Record.ГодРасчета[j].УчетныйГод = локРасчетСзСС.ГодРасчета[i].УчетныйГод;
        Self.Record.ГодРасчета[j].СуммаВРасчете = локРасчетСзСС.ГодРасчета[i].СуммаВРасчете;
        Self.Record.ГодРасчета[j].КДВРасчете = локРасчетСзСС.ГодРасчета[i].КДКорр;
      end;
    fi;
end;


end